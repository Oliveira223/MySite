name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script: |
          # Entra na pasta do projeto
          cd ~/MySite
          
          echo "=== DIAGNÓSTICO DE DEPLOY ==="
          echo "Diretório atual:"
          pwd
          
          # Verifica se é um repositório git, se não for, inicializa
          if [ ! -d ".git" ]; then
            echo "⚠️ AVISO: Diretório não é um repositório Git. Inicializando..."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
            echo "Remote adicionado: https://github.com/${{ github.repository }}.git"
          fi
          
          echo "Remote URL:"
          git remote -v
          
          echo "Tentando buscar atualizações do GitHub..."
          # Fetch forçado
          if ! git fetch origin main; then
              echo "❌ ERRO CRÍTICO: Não foi possível baixar o código do GitHub."
              echo "Tentativa de correção: Resetando URL do remote..."
              git remote set-url origin https://github.com/${{ github.repository }}.git
              if ! git fetch origin main; then
                 echo "❌ FALHA DUPLA: Ainda não consigo acessar o repositório."
                 exit 1
              fi
          fi
          
          echo "Resetando para a versão mais recente (origin/main)..."
          git reset --hard origin/main
          
          echo "Commit NOVO (Após Reset):"
          git log -1 --format="%h - %s"
          
          echo "=== VERIFICAÇÃO DE ARQUIVOS ==="
          if [ -d "app/vps" ]; then
              echo "✅ SUCESSO: Pasta 'app/vps' encontrada!"
              ls -R app/vps
          else
              echo "❌ ERRO: A pasta 'app/vps' NÃO existe após a atualização."
              echo "Isso significa que o GitHub (origin/main) não tem essa pasta."
              echo "Conteúdo de app/:"
              ls -F app/
          fi
          echo "================================="
          
          # Instala dependências (caso necessário para scripts locais)
          # npm install --production # Opcional se tudo roda no Docker
          
          # Reconstrói e reinicia o container usando Docker Compose
          # Se não tiver docker compose plugin (v2), tenta docker-compose (v1)
          if docker compose version >/dev/null 2>&1; then
            docker compose up -d --build
          else
            docker-compose up -d --build
          fi
          
          # Limpa imagens antigas para economizar espaço
          docker image prune -f
